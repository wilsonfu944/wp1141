# 海龜湯 LINE Bot 對話/功能設計文件

## 1. 主題

**海龜湯推理遊戲** - 一個經典的推理遊戲，玩家需要通過提問來找出故事背後的真相。AI 扮演莊家角色，提供謎題並回答玩家的問題。

## 2. 功能列表

### 核心功能
- **開始遊戲**：隨機選擇一個海龜湯謎題開始新遊戲
- **提問推理**：玩家可以提出任何問題，AI 只能回答「是」、「不是」或「無關」
- **獲得提示**：當玩家卡關時，可以請求提示
- **查看謎題**：重新查看當前謎題的故事內容
- **重新開始**：放棄當前謎題，開始新的遊戲

### 輔助功能
- **快速回覆按鈕**：提供常用指令的快速按鈕
- **對話歷史**：保存完整的對話記錄，維持上下文連貫性
- **遊戲狀態追蹤**：記錄當前謎題、是否解決、使用提示次數等

## 3. 對話腳本

### 3.1 歡迎訊息
當使用者首次互動或沒有進行中的遊戲時：
```
歡迎來到海龜湯遊戲！

我是莊家，會給你一個故事，你需要通過提問來找出真相。

我只能回答「是」、「不是」或「無關」。

輸入「開始」來開始遊戲吧！
```
**快速回覆按鈕**：`開始遊戲`

### 3.2 開始新遊戲
當使用者輸入「開始」、「開始遊戲」或「新遊戲」時：
```
好的！讓我們開始新的海龜湯遊戲。

📖 謎題：[謎題標題]

[謎題故事內容]

現在你可以開始提問了！我只能回答「是」、「不是」或「無關」。
```
**快速回覆按鈕**：`我要提示`、`重新開始`

### 3.3 遊戲進行中
當玩家提出問題時，AI 會根據問題內容回答：
- **是**：當問題的答案是肯定的
- **不是**：當問題的答案是否定的
- **無關**：當問題與謎題無關時
- **提示性回答**：當玩家接近答案時，給予適當的引導

**快速回覆按鈕**：`我要提示`、`重新開始`

### 3.4 提示功能
當使用者輸入「提示」或「我要提示」時：
```
💡 提示：[根據已使用提示次數提供不同層級的提示]
```
**快速回覆按鈕**：`繼續提問`、`重新開始`

提示層級：
1. 第一層：試著思考故事中的細節，哪些地方看起來不合理？
2. 第二層：注意故事中的人物行為，他們為什麼會這樣做？
3. 第三層：想想故事中沒有直接說明的部分，可能隱藏了什麼？
4. 第四層：答案往往在於理解角色的動機和背景。

### 3.5 查看當前謎題
當使用者輸入「當前謎題」或「謎題」時：
```
📖 當前謎題：[謎題標題]

[謎題故事內容]
```
**快速回覆按鈕**：`我要提示`、`繼續提問`

### 3.6 解決謎題
當玩家猜出答案時：
```
[AI 的確認回應]

🎉 恭喜你！你猜對了！

📚 完整故事：[完整的故事解釋]

輸入「開始」來開始新的遊戲吧！
```
**快速回覆按鈕**：`開始新遊戲`

### 3.7 錯誤處理
當系統發生錯誤時：
```
抱歉，處理你的訊息時發生錯誤。請稍後再試，或輸入「重新開始」來開始新遊戲。
```
**快速回覆按鈕**：`重新開始`

當 LLM 服務不可用時：
```
抱歉，AI 服務暫時無法使用。請稍後再試，或輸入「重新開始」來開始新遊戲。
```

## 4. 對話脈絡

### 4.1 上下文維持機制
- **對話歷史保存**：所有對話（使用者訊息、AI 回應、系統訊息）都會保存到資料庫
- **歷史訊息檢索**：每次處理新訊息時，會檢索最近 10 條對話記錄
- **上下文傳遞**：將對話歷史格式化後傳遞給 LLM，讓 AI 能夠理解對話脈絡

### 4.2 遊戲狀態管理
- **當前謎題**：記錄使用者正在進行的謎題 ID 和標題
- **解決狀態**：追蹤謎題是否已被解決
- **提示使用**：記錄使用者已使用的提示次數
- **開始時間**：記錄遊戲開始的時間

### 4.3 對話連貫性
- 系統會根據對話歷史判斷使用者是否在進行遊戲
- 如果沒有進行中的遊戲，會引導使用者開始新遊戲
- 如果謎題已解決，會提示使用者開始新遊戲

## 5. LLM Prompt Template 設計

### 5.1 系統提示詞（System Prompt）
```
你是一個海龜湯遊戲的莊家。海龜湯是一個推理遊戲，玩家需要通過提問來找出故事背後的真相。

規則：
1. 你只能回答「是」、「不是」或「無關」
2. 如果玩家問的問題與謎題無關，回答「無關」
3. 如果玩家接近答案，可以給予適當的提示
4. 保持神秘和有趣的語氣
5. 當玩家猜出答案時，給予肯定並解釋完整故事

當前謎題：{PUZZLE_STORY}

請根據玩家的問題，用簡短的方式回答（「是」、「不是」或「無關」），必要時可以給予提示。
```

### 5.2 對話格式
```
玩家: [使用者問題]
莊家: [AI 回應]
玩家: [使用者問題]
莊家: [AI 回應]
...
玩家: [當前問題]
莊家: [AI 需要生成的回應]
```

### 5.3 Prompt 構建邏輯
1. 將系統提示詞中的 `{PUZZLE_STORY}` 替換為當前謎題的故事
2. 將對話歷史轉換為「玩家: ... / 莊家: ...」格式
3. 添加當前使用者的問題
4. 最後加上「莊家: 」讓 AI 生成回應

## 6. 回應設計

### 6.1 回應包裝策略
- **預設腳本優先**：對於特殊指令（開始、提示、查看謎題等），使用預設腳本回應
- **LLM 生成**：對於一般提問，使用 LLM 生成回應
- **混合模式**：在 LLM 回應後，根據情況添加快速回覆按鈕

### 6.2 快速回覆按鈕設計
根據不同情境提供不同的快速回覆選項：

| 情境 | 快速回覆按鈕 |
|------|------------|
| 未開始遊戲 | `開始遊戲` |
| 遊戲進行中 | `我要提示`、`重新開始` |
| 查看謎題後 | `我要提示`、`繼續提問` |
| 獲得提示後 | `繼續提問`、`重新開始` |
| 解決謎題後 | `開始新遊戲` |
| 錯誤發生時 | `重新開始` |

### 6.3 多媒體支援
目前主要使用文字訊息和快速回覆按鈕。未來可擴展：
- 圖片訊息（謎題插圖）
- 影片訊息（遊戲說明）
- 位置訊息（相關地點）

## 7. 謎題庫設計

### 7.1 當前謎題
1. **電梯**：關於侏儒無法按到高樓層按鈕的故事
2. **盲人**：關於盲人為導盲犬報仇的故事
3. **房間**：關於電梯墜落的故事

### 7.2 謎題結構
每個謎題包含：
- `id`：唯一識別碼
- `title`：謎題標題
- `story`：謎題故事內容
- `answer`：完整答案解釋

### 7.3 擴展性
謎題庫設計為陣列結構，可以輕鬆添加新謎題。未來可以：
- 從資料庫載入謎題
- 根據難度分類
- 支援使用者自訂謎題

## 8. 錯誤處理與降級策略

### 8.1 LLM 服務錯誤
- **404 錯誤**：模型不存在，嘗試使用備用模型
- **429 錯誤**：配額或速率限制，返回友善錯誤訊息
- **503 錯誤**：服務不可用，返回降級訊息
- **其他錯誤**：返回通用錯誤訊息

### 8.2 降級回應
當 LLM 服務完全不可用時：
```
抱歉，AI 服務暫時無法使用。請稍後再試，或輸入「重新開始」來開始新遊戲。
```

### 8.3 資料庫錯誤
- 連接失敗時記錄錯誤並返回通用錯誤訊息
- 確保不會因為資料庫問題導致整個服務崩潰

## 9. 使用者體驗優化

### 9.1 回應時間
- 預設腳本回應：即時
- LLM 生成回應：通常 1-3 秒

### 9.2 錯誤恢復
- 所有錯誤都提供「重新開始」選項
- 確保使用者不會卡在錯誤狀態

### 9.3 引導機制
- 首次使用時提供清楚的遊戲說明
- 每個階段都有適當的快速回覆按鈕
- 錯誤時提供明確的下一步指引

## 10. 未來擴展方向

1. **更多謎題**：擴充謎題庫，支援不同難度等級
2. **成就系統**：記錄解決的謎題數量、使用提示次數等
3. **多人模式**：支援多人一起推理
4. **自訂謎題**：允許使用者提交自己的謎題
5. **語音支援**：支援語音輸入和輸出
6. **圖片謎題**：支援包含圖片的謎題


